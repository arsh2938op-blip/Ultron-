<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultron AI Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar {
            width: 6px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 3px;
        }
        .bot-message {
            background-color: #ffffff;
            border-left: 3px solid #10b981;
        }
        .user-message {
            background-color: #e0f2f1;
            border-right: 3px solid #047857;
        }
        /* Loading animation for the waiting state */
        .dot-flashing {
          position: relative;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: #10b981;
          color: #10b981;
          animation: dot-flashing 1s infinite alternate;
          animation-delay: 0s;
        }
        .dot-flashing::before, .dot-flashing::after {
          content: '';
          display: inline-block;
          position: absolute;
          top: 0;
        }
        .dot-flashing::before {
          left: -12px;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: #10b981;
          color: #10b981;
          animation: dot-flashing 1s infinite alternate;
          animation-delay: 0.3s;
        }
        .dot-flashing::after {
          left: 12px;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: #10b981;
          color: #10b981;
          animation: dot-flashing 1s infinite alternate;
          animation-delay: 0.6s;
        }
        @keyframes dot-flashing {
          0% { opacity: 0.2; }
          100% { opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl flex flex-col h-[90vh]">
        <!-- Header -->
        <header class="p-4 bg-emerald-600 text-white rounded-t-xl shadow-md">
            <h1 class="text-2xl font-bold">Ultron Chat Interface</h1>
            <p class="text-sm opacity-90">Powered by Gemini AI</p>
        </header>

        <!-- Chat History -->
        <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto">
            <!-- Initial Message -->
            <div class="flex justify-start">
                <div class="bot-message max-w-xs md:max-w-md p-3 rounded-lg shadow-sm text-gray-700">
                    <p>Hello! I am Ultron. Ask me anything, and I'll do my best to help you.</p>
                </div>
            </div>
            <!-- Dynamic messages will be added here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-200">
            <div id="loading-indicator" class="hidden justify-start mb-3">
                <div class="flex items-center space-x-2">
                    <div class="dot-flashing"></div>
                    <span class="text-sm text-gray-500">Ultron is thinking...</span>
                </div>
            </div>
            <div class="flex space-x-3">
                <textarea 
                    id="user-input" 
                    rows="1" 
                    placeholder="Type your message here..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 resize-none"
                    oninput="autoExpand(this)"
                    onkeypress="handleKeyPress(event)"
                ></textarea>
                <button 
                    id="send-button"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-md disabled:opacity-50"
                    onclick="sendMessage()"
                >
                    Send
                </button>
            </div>
            <p id="error-message" class="text-sm text-red-500 mt-2 hidden">An error occurred. Please check your API key or network connection.</p>
        </div>
    </div>

    <script>
        // API Key INJECTION FIX: This key should now resolve the 403 error.
        // NOTE: Putting an API key directly in public client-side code is a security risk. 
        // For production, you should use a backend proxy.
        const apiKey = "AIzaSyCoccMDLQeQ4GxsbYeVuz93Avgl8iVyjJw";
        const model = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        // Role-setting for the AI
        const systemPrompt = "You are Ultron, a helpful, advanced, and slightly dry AI assistant. Keep your responses concise and accurate.";
        
        // This array will store the conversation history
        let chatHistory = [];
        let isWaitingForResponse = false;
        
        const chatHistoryDiv = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');

        // Utility to auto-expand textarea height
        function autoExpand(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent new line
                sendMessage();
            }
        }

        // Add a message bubble to the chat history
        function addMessage(text, sender) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs md:max-w-md p-3 rounded-lg shadow-md text-gray-800 ${sender === 'user' ? 'user-message' : 'bot-message'}`;
            messageBubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Basic markdown bolding

            messageContainer.appendChild(messageBubble);
            chatHistoryDiv.appendChild(messageContainer);
            
            // Scroll to the bottom
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        // Update UI state (loading/enabled)
        function setUiState(isLoading) {
            isWaitingForResponse = isLoading;
            userInput.disabled = isLoading;
            sendButton.disabled = isLoading;
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.classList.add('flex');
            } else {
                loadingIndicator.classList.remove('flex');
                loadingIndicator.classList.add('hidden');
            }
        }

        // Exponential backoff logic for retries
        async function fetchWithRetry(url, payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 403) {
                         // Specific check for 403 to skip retry and throw a clear error
                         throw new Error("API Key Forbidden (403). Check key validity and restrictions.");
                    }

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    return await response.json();

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1 || error.message.includes("403")) {
                        throw error;
                    }
                    // Wait with exponential backoff
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Main function to send message and get response
        async function sendMessage() {
            if (isWaitingForResponse) return;

            const message = userInput.value.trim();
            if (!message) return;

            // Clear any previous error messages
            errorMessage.classList.add('hidden');

            // 1. Display user message and clear input
            addMessage(message, 'user');
            userInput.value = '';
            autoExpand(userInput);

            // 2. Add user message to history
            chatHistory.push({ role: "user", parts: [{ text: message }] });
            
            // 3. Set UI to loading
            setUiState(true);

            // Construct payload for the API call
            const payload = {
                contents: chatHistory,
                // System instructions guide the AI's persona
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await fetchWithRetry(apiUrl, payload);
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const botResponse = candidate.content.parts[0].text;
                    
                    // 4. Display bot response
                    addMessage(botResponse, 'bot');
                    
                    // 5. Add bot response to history
                    chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                } else {
                    addMessage("I received an empty response. Please try again.", 'bot');
                    console.error("Empty response received from API:", result);
                }

            } catch (error) {
                // 6. Handle errors (e.g., network, 403, bad response)
                console.error("Fatal Error during chat:", error);
                errorMessage.textContent = error.message.includes("403") 
                    ? "Error 403: API Key is invalid or restricted. Please check your key permissions."
                    : "A network or API error occurred. Check console for details.";
                errorMessage.classList.remove('hidden');

                // If error, remove the last user message from history so it doesn't confuse future context
                chatHistory.pop(); 
            } finally {
                // 7. Reset UI state
                setUiState(false);
            }
        }
    </script>
</body>
</html>